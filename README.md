# Архитектура интеграции Алисы в Яндекс Маркет
## Функционал "Повторная покупка расходников через Алису"

## 1. Описание решения

Архитектура реализует функционал повторной покупки расходников через голосового помощника Алису на устройствах Яндекса. Основной сценарий: Алиса напоминает о товарах-расходниках, которые пользователь покупал ранее в Яндекс Маркете, и предлагает повторить заказ голосовым подтверждением.

## 2. Архитектура решения

```mermaid
flowchart TD
    %% Устройства
    subgraph "Пользовательские устройства"
        A[Яндекс Станция] --> |gRPC| B
        M[Другие устройства с Алисой] --> |gRPC| B
    end

    %% Основные сервисы
    subgraph "Основные сервисы"
        B[Бэкенд Алисы\nGo + gRPC + Protobuf] <--> |gRPC| C
        B <--> |gRPC| D
        B <--> |gRPC| E
        
        C[Сервис расходников и рекомендаций\nPython + ML] <--> |REST API| N
    end
    
    %% Хранилища данных
    subgraph "Хранилища данных"
        F[(PostgreSQL\nМетаданные товаров)]
        G[(ClickHouse\nАналитические данные)]
        H[(Redis Cache\nКэш расходников)]
        I[(Redis Queue\nОчереди уведомлений)]
        L[(Redis Cart\nСостояние корзины)]
    end
    
    %% Очереди сообщений
    subgraph "Очереди и потоки данных"
        Q[Apache Kafka\nСобытия покупок]
        K[RabbitMQ\nСообщения заказов]
    end
    
    %% Внешние сервисы Я.Маркета
    subgraph "Сервисы Яндекс Маркета"
        N[Товарный поиск] 
        O[Сервис цен] 
        P[Сервис заказов]
    end
    
    %% Дополнительные сервисы
    D[Сервис уведомлений\nGo + Redis] --> I
    D <--> J[Apache Airflow\nПланировщик задач]
    E[Сервис корзины и оформления\nJava Spring] --> K
    E --> L
    E <--> |REST API| O
    E <--> |REST API| P
    
    %% Связи с БД и Очередями
    C --> F
    C --> G
    C --> H
    C <--> Q
    N <--> Q
```

## 3. Компоненты системы

### 3.1 Бэкенд Алисы
- **Назначение**: Обработка голосовых команд, распознавание намерений, формирование ответов
- **Технологии**: 
  - gRPC для межсервисных коммуникаций
  - Протобуф для сериализации данных
  - Go для обработки запросов (высокая производительность, низкая латентность)
- **Особенности**: Кэширование часто используемых данных в Redis для соблюдения лимита в 300 мс

### 3.2 Сервис расходников и рекомендаций
- **Назначение**: Определение товаров-расходников, расчет времени для повторной покупки
- **Технологии**:
  - Python + ML-модели для классификации товаров как расходников
  - Apache Kafka для потоковой обработки данных о покупках
  - ClickHouse для аналитического хранилища
  - PostgreSQL для хранения метаданных
- **Особенности**: Предрасчет рекомендаций в отложенном режиме, чтобы не задерживать ответ Алисы

### 3.3 Сервис уведомлений
- **Назначение**: Планирование и триггеринг уведомлений для пользователей
- **Технологии**:
  - Go для основного сервиса (эффективность и скорость)
  - Redis для очередей и отложенных задач
  - Apache Airflow для планирования напоминаний
- **Особенности**: Балансировка нагрузки между разными временными слотами для равномерного распределения напоминаний

### 3.4 Сервис корзины и оформления
- **Назначение**: Создание заказов в корзине и отправка уведомлений в приложение Маркета
- **Технологии**:
  - Java (Spring Boot) для совместимости с экосистемой Маркета
  - RabbitMQ для надежной доставки сообщений
  - Redis для кэширования состояния корзины
- **Особенности**: Асинхронная обработка для снижения задержек

### 3.5 Интеграция с сервисами Яндекс Маркета
- **Товарный поиск**: Интеграция через API с кэшированием популярных запросов
- **Сервис цен**: Предзагрузка актуальных цен для потенциальных расходников
- **Сервис заказов**: Асинхронное создание заказов через очереди сообщений

## 4. Потоки данных

### 4.1 Определение расходников и планирование напоминаний

```mermaid
sequenceDiagram
    participant YM as Я.Маркет API
    participant KAF as Kafka (События покупок)
    participant SR as Сервис расходников (Python + ML)
    participant CH as ClickHouse (Аналитика)
    participant PG as PostgreSQL (Метаданные)
    participant AF as Apache Airflow
    participant SU as Сервис уведомлений (Go)
    participant RQ as Redis Queue
    
    Note over YM, RQ: Процесс анализа покупок и планирования напоминаний
    
    YM ->> KAF: События покупок пользователей
    KAF ->> SR: Потоковая обработка событий
    
    activate SR
    Note over SR: Ежедневный бэтч-процесс
    
    SR ->> CH: INSERT INTO purchases_analytics
    SR ->> PG: UPDATE product_metadata
    
    Note over SR: ML-классификация товаров
    SR ->> SR: TensorFlow модель классификации
    
    SR ->> PG: INSERT INTO consumables_categories
    
    Note over SR: Расчет интервалов для повторной покупки
    SR ->> PG: SELECT purchase_frequency FROM user_stats
    
    SR ->> AF: Создание DAG-задач напоминаний
    deactivate SR
    
    activate AF
    AF ->> SU: Планирование напоминаний
    deactivate AF
    
    activate SU
    SU ->> SU: Оптимизация времени напоминаний
    SU ->> RQ: ZADD scheduled_notifications
    deactivate SU
```

### 4.2 Процесс напоминания и заказа

```mermaid
sequenceDiagram
    participant U as Пользователь
    participant S as Станция (Устройство)
    participant BA as Бэкенд Алисы (Go)
    participant RC as Redis Cache
    participant SU as Сервис уведомлений (Go)
    participant RQ as Redis Queue
    participant SR as Сервис расходников (Python)
    participant PG as PostgreSQL
    participant SC as Сервис цен (Я.Маркет)
    participant SK as Сервис корзины (Java Spring)
    participant RMQ as RabbitMQ
    participant PM as Приложение Маркета
    
    Note over SU, RQ: Инициирование напоминания
    
    SU ->> RQ: ZPOPMIN scheduled_notifications
    RQ ->> SU: Данные для напоминания
    SU ->> BA: POST /notify (gRPC)
    
    Note over BA, RC: Ожидание активации устройства
    
    U ->> S: Активация устройства
    S ->> BA: Запрос диалога (gRPC)
    BA ->> RC: GET user_notifications
    
    BA ->> SR: GET /consumables/recommend (gRPC)
    SR ->> PG: SELECT FROM consumables WHERE user_id = ?
    PG ->> SR: Данные о расходниках
    SR ->> BA: Информация о товаре
    
    BA ->> S: "Напоминаю: месяц назад вы покупали корм для кошки. Хотите заказать снова?"
    S ->> U: Озвучивание напоминания
    
    U ->> S: "Да"
    S ->> BA: Подтверждение (gRPC)
    
    BA ->> SC: GET /prices/{item_id} (REST API)
    SC ->> BA: {"price": 1299, "delivery_date": "tomorrow"}
    
    BA ->> S: "Корм Royal Canin, доставка завтра, стоимость 1 299 рублей. Оформляем заказ?"
    S ->> U: Озвучивание деталей
    
    U ->> S: "Подтверждаю"
    S ->> BA: Финальное подтверждение (gRPC)
    
    BA ->> SK: POST /create_order (gRPC)
    SK ->> RMQ: Публикация сообщения о заказе
    RMQ ->> PM: Обработка сообщения
    SK ->> PM: Push-уведомление
    BA ->> S: "Отлично! Заказ создан. Завершить оформление можно в приложении Яндекс Маркет."
    S ->> U: Озвучивание результата
    
    Note over U, PM: Пользователь завершает оформление заказа в приложении
```

## 5. Обеспечение нефункциональных требований

### 5.1 Производительность (лимит 300 мс)
- Предрасчет и кэширование данных для быстрого ответа
- Асинхронное выполнение долгих операций
- Использование высокопроизводительных языков (Go) для критичных компонентов
- Горизонтальное масштабирование сервисов под нагрузкой
- Многоуровневое кэширование (Redis + локальные кэши)

### 5.2 Надежность
- Отказоустойчивое проектирование всех компонентов (минимум N+1 реплик)
- Сервисы с состоянием дублируются в разных дата-центрах
- Очереди сообщений гарантируют доставку событий даже при сбоях
- Circuit breaker для предотвращения каскадных отказов
- Стратегия деградации: даже при проблемах с рекомендациями основной функционал Алисы работает

### 5.3 Масштабируемость
- Микросервисная архитектура для независимого масштабирования компонентов
- Stateless-дизайн для горизонтального масштабирования
- Шардирование данных для равномерного распределения нагрузки

## 6. Используемые технологии и обоснование выбора

| Компонент | Технологии | Обоснование |
|-----------|------------|-------------|
| Основные сервисы | Go | Низкая латентность, эффективное использование ресурсов, отличная параллельная обработка |
| ML-компоненты | Python | Богатая экосистема библиотек ML/AI (TensorFlow, PyTorch, scikit-learn) |
| Хранение данных | PostgreSQL, ClickHouse | PostgreSQL для ACID-транзакций, ClickHouse для аналитики и большого объема данных |
| Межсервисное взаимодействие | gRPC, Protobuf | Высокая производительность, строгая типизация, компактный формат |
| Очереди и потоки | Kafka, RabbitMQ | Kafka для высоконагруженных потоков, RabbitMQ для надежной доставки сообщений |
| Кэширование | Redis | Низкая латентность, атомарные операции, поддержка различных структур данных |
| Мониторинг | Prometheus, Grafana | Стандарт индустрии, высокая масштабируемость, богатая визуализация |
| CI/CD | GitLab CI, Kubernetes | Автоматизация развертывания, управление контейнерами, горизонтальное масштабирование | 