# Архитектура интеграции Алисы в Яндекс Маркет
## Функционал "Повторная покупка расходников через Алису"

## 1. Описание решения

Архитектура реализует функционал повторной покупки расходников через голосового помощника Алису на устройствах Яндекса. Основной сценарий: Алиса напоминает о товарах-расходниках, которые пользователь покупал ранее в Яндекс Маркете, и предлагает повторить заказ голосовым подтверждением.

## 2. Архитектура решения

```mermaid
flowchart TB
    classDef service fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef database fill:#ffebee,stroke:#b71c1c,stroke-width:2px
    classDef external fill:#f9fbe7,stroke:#827717,stroke-width:2px
    classDef messaging fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px
    classDef client fill:#fff3e0,stroke:#e65100,stroke-width:2px

    %% Клиентские устройства
    devices[Устройства с Алисой<br>Станции, колонки, приложения]:::client
    
    %% Монолит Алисы    
    subgraph alice [Бэкенд Алисы]
        direction TB
        alice_core[Ядро Алисы<br>Go + gRPC]:::service
        consumables_module[Модуль расходников<br>и рекомендаций]:::service
        notification_module[Модуль<br>уведомлений]:::service
        cart_module[Модуль корзины<br>и заказов]:::service
    end
    
    %% Хранилища данных
    subgraph data_stores [Хранилища данных]
        direction LR
        postgres[(PostgreSQL<br>Данные товаров)]:::database
        clickhouse[(ClickHouse<br>Аналитика)]:::database
        redis[(Redis<br>Кэш + Очереди)]:::database
    end
    
    %% Очереди сообщений
    kafka[Apache Kafka<br>События покупок]:::messaging
    
    %% Сервисы Яндекс.Маркета
    subgraph market [Яндекс.Маркет]
        direction TB
        search[Товарный поиск]:::external
        price[Сервис цен]:::external
        order[Сервис заказов]:::external
    end
    
    %% Связи
    devices <---> |gRPC| alice_core
    
    alice_core --> notification_module
    alice_core --> consumables_module
    alice_core --> cart_module
    
    notification_module --> redis
    consumables_module --> postgres
    consumables_module --> clickhouse
    consumables_module --> redis
    cart_module <==> |REST API| order
    
    consumables_module <---> |Потоки событий| kafka
    search <---> kafka
    
    consumables_module <---> |REST API| search
    cart_module <---> |REST API| price
```

## 3. Компоненты системы

### 3.1 Ядро Алисы
- **Назначение**: Обработка голосовых команд, распознавание намерений, маршрутизация запросов
- **Технологии**: 
  - Go для основного кода (низкая латентность, высокая производительность)
  - gRPC для внешнего API
  - Протобуф для сериализации данных
- **Особенности**: Единый вход для всех запросов от устройств с Алисой

### 3.2 Модуль расходников и рекомендаций
- **Назначение**: Определение товаров-расходников, расчет времени для повторной покупки
- **Технологии**:
  - ML-модели для классификации товаров
  - Интеграция с потоком событий покупок через Kafka
  - Предварительный расчет рекомендаций
- **Особенности**: Работает в фоновом режиме для подготовки данных

### 3.3 Модуль уведомлений
- **Назначение**: Планирование и управление уведомлениями для пользователей
- **Технологии**:
  - Планировщик на базе Redis для отложенных напоминаний
  - Алгоритмы оптимизации времени уведомлений
- **Особенности**: Интеллектуальное планирование для максимального отклика

### 3.4 Модуль корзины и заказов
- **Назначение**: Взаимодействие с сервисами Маркета для создания заказов
- **Технологии**:
  - Интеграция с API Яндекс.Маркета
  - Асинхронное создание заказов
- **Особенности**: Минимизация задержек при взаимодействии с внешними сервисами

## 4. Потоки данных

### 4.1 Определение расходников и планирование напоминаний

```mermaid
sequenceDiagram
    participant Market as Яндекс.Маркет
    participant Kafka
    participant Module as Модуль расходников
    participant DB as БД (PostgreSQL/ClickHouse)
    participant NotificationModule as Модуль уведомлений
    participant Redis
    
    Note over Market, Redis: Процесс анализа покупок и планирования напоминаний
    
    Market ->> Kafka: События покупок пользователей
    activate Kafka
    Kafka ->> Module: Потоковая обработка событий
    deactivate Kafka
    
    activate Module
    Module ->> Module: Анализ и классификация товаров
    Module ->> DB: Сохранение аналитики и метаданных
    
    Module ->> Module: Расчет интервалов для повторных покупок
    
    Module ->> NotificationModule: Запрос на создание напоминаний
    deactivate Module
    
    activate NotificationModule
    NotificationModule ->> NotificationModule: Оптимизация времени уведомлений
    NotificationModule ->> Redis: Планирование напоминаний
    deactivate NotificationModule
```

### 4.2 Процесс напоминания и заказа

```mermaid
sequenceDiagram
    participant User as Пользователь
    participant Device as Устройство с Алисой
    participant Core as Ядро Алисы
    participant Notify as Модуль уведомлений
    participant Consumables as Модуль расходников
    participant Cart as Модуль корзины
    participant Market as Сервисы Яндекс.Маркета
    participant App as Приложение Я.Маркета
    
    activate Notify
    Notify ->> Core: Запрос на отправку напоминания
    deactivate Notify
    
    Note over Core: Ожидание активации устройства
    
    User ->> Device: Активация устройства
    Device ->> Core: Запрос диалога
    
    activate Core
    Core ->> Consumables: Запрос товаров для напоминания
    Consumables ->> Core: Информация о товаре-расходнике
    
    Core ->> Device: "Напоминаю: месяц назад вы покупали корм для кошки. Хотите заказать снова?"
    Device ->> User: Озвучивание предложения
    
    User ->> Device: "Да"
    Device ->> Core: Подтверждение
    
    Core ->> Market: Запрос актуальной цены и доставки
    Market ->> Core: Данные о цене и доставке
    
    Core ->> Device: "Корм Royal Canin, доставка завтра, стоимость 1 299 рублей. Оформляем заказ?"
    Device ->> User: Озвучивание деталей
    
    User ->> Device: "Подтверждаю"
    Device ->> Core: Финальное подтверждение
    
    Core ->> Cart: Запрос на создание заказа
    Cart ->> Market: Создание заказа
    Market ->> App: Уведомление о заказе
    
    Core ->> Device: "Отлично! Заказ создан. Завершить оформление можно в приложении Яндекс Маркет."
    deactivate Core
    Device ->> User: Озвучивание результата
```

## 5. Обеспечение нефункциональных требований

### 5.1 Производительность (лимит 300 мс)
- Монолитный подход с модульной структурой минимизирует сетевые задержки
- Предрасчет и кэширование данных для быстрого ответа
- Асинхронное выполнение долгих операций
- Использование высокопроизводительных языков (Go) для ядра
- Многоуровневое кэширование наиболее востребованных данных

### 5.2 Надежность
- Отказоустойчивое проектирование основных компонентов
- Деградация функциональности при недоступности внешних сервисов
- Механизмы повторных попыток и компенсирующих транзакций
- Circuit breaker для защиты от каскадных отказов
- Регулярное резервное копирование данных

### 5.3 Масштабируемость
- Горизонтальное масштабирование бэкенда Алисы
- Разделение задач реального времени и фоновой обработки
- Возможность независимого масштабирования модулей при необходимости

## 6. Используемые технологии и обоснование выбора

| Компонент | Технологии | Обоснование |
|-----------|------------|-------------|
| Ядро Алисы | Go | Низкая латентность, эффективное использование ресурсов, высокая производительность для обработки запросов в реальном времени |
| ML-компоненты | Python | Богатая экосистема библиотек ML/AI, удобство разработки и итерации моделей |
| Хранение данных | PostgreSQL, ClickHouse | PostgreSQL для транзакционных данных, ClickHouse для аналитических запросов и больших объемов данных |
| Межсервисное взаимодействие | gRPC, REST API | gRPC для внутренних высокопроизводительных вызовов, REST API для совместимости с существующими сервисами |
| Очереди и потоки | Kafka | Высокая производительность для обработки потоков событий, гарантии доставки |
| Кэширование | Redis | Низкая латентность, поддержка различных структур данных и паттернов (кэш, очереди, планировщик) |
| Мониторинг | Prometheus, Grafana | Комплексное наблюдение за системой, визуализация метрик, алертинг |
| Деплой | Kubernetes | Управление контейнерами, оркестрация, масштабирование | 